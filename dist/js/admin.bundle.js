document.addEventListener("DOMContentLoaded",(async()=>{const t=document.getElementById("teamSelect"),e=document.getElementById("players"),a=document.getElementById("playerStats"),n=document.getElementById("statsForm"),i=document.getElementById("cancelStats"),s=document.getElementById("newPlayerForm");let o=null,l=null;async function c(t,e={}){try{const a=await fetch(t,e);if(!a.ok)throw new Error(`Ошибка ${a.status} при загрузке ${t}`);return await a.json()}catch(t){return alert(t.message),console.error(t),null}}async function r(t){let i=`/api/admin/players?teamId=${t}`;3==+t&&(i="/api/admin/players/archive");const s=await c(i);s&&(e.innerHTML="",s.forEach((i=>{const s=document.createElement("div");if(s.classList.add("player-item"),s.textContent=`${i.name} — ${i.position}, №${i.number}`,3==+t){const t=document.createElement("button");t.textContent="Восстановить",t.classList.add("button-small"),t.onclick=()=>async function(t){const e=await c("/api/admin/teams/active");if(!e)return;const a=prompt(`Введите ID команды для восстановления:\n${e.map((t=>`${t.id} - ${t.name}`)).join("\n")}`),n=e.find((t=>t.id==a));n?(await fetch(`/api/admin/players/${t}/move`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({newTeamId:n.id})})).ok?await r(o):alert("Ошибка при восстановлении игрока"):alert("Неверный выбор команды")}(i.id),s.appendChild(t)}else{const t=document.createElement("button");t.textContent="В архив",t.classList.add("button-small"),t.onclick=()=>async function(t){(await fetch(`/api/admin/players/${t}/move`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({newTeamId:3})})).ok?(await r(o),a.style.display="none"):alert("Ошибка при отправке в архив")}(i.id),s.appendChild(t),s.style.cursor="pointer",s.onclick=()=>async function(t){l=t;const e=await c(`/api/admin/players/${t}/statistics`);e?(n.matches.value=e.matches||0,n.goals.value=e.goals||0,n.assists.value=e.assists||0,n.zeromatch.value=e.zeromatch||0,n.lostgoals.value=e.lostgoals||0,n.zanetti_priz.value=e.zanetti_priz||0,a.style.display="block"):alert("Статистика не найдена")}(i.id)}e.appendChild(s)})))}function d(t){const e=t.trim().split(" ");return 3===e.length?e[2]:""}n.addEventListener("submit",(async t=>{if(t.preventDefault(),!l)return;const e={matches:+n.matches.value,goals:+n.goals.value,assists:+n.assists.value,zeromatch:+n.zeromatch.value,lostgoals:+n.lostgoals.value,zanetti_priz:+n.zanetti_priz.value};(await fetch(`/api/admin/players/${l}/statistics`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok?alert("Статистика сохранена"):alert("Ошибка при сохранении статистики")})),i.addEventListener("click",(()=>{a.style.display="none"})),s.addEventListener("submit",(async t=>{if(t.preventDefault(),!o)return void alert("Выберите команду");const e=new FormData(s),a={team_id:o,name:e.get("name"),number:e.get("number"),position:e.get("position"),birth_date:e.get("birth_date"),height_cm:e.get("height_cm")||null,weight_kg:e.get("weight_kg")||null,is_captain:e.get("is_captain")?1:0,patronymic:d(e.get("name"))};(await fetch("/api/admin/players",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok?(alert("Игрок добавлен"),s.reset(),await r(o)):alert("Ошибка при добавлении игрока")})),t.addEventListener("change",(async()=>{o=t.value,await r(o),a.style.display="none"})),await async function(){const e=await c("/api/admin/teams/active");e&&(e.push({id:3,name:"Архив"}),t.innerHTML="",e.forEach((e=>{const a=document.createElement("option");a.value=e.id,a.textContent=e.name,t.appendChild(a)})),!o&&e.length>0&&(o=e[0].id),t.value=o,await r(o))}()}));