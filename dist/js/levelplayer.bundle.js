document.addEventListener("DOMContentLoaded",(async()=>{const e=new URLSearchParams(window.location.search).get("id");if(!e)return console.error("ID игрока не указан в URL");function t(e,t="full"){const a=new Date(e);return"short"===t?a.getFullYear().toString():"numeric"===t?`${String(a.getDate()).padStart(2,"0")}.${String(a.getMonth()+1).padStart(2,"0")}.${a.getFullYear()}`:a.toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"})}function a(e,t){const a=e%10,n=e%100;return n>=11&&n<=14?t[2]:1===a?t[0]:a>=2&&a<=4?t[1]:t[2]}try{const n=await fetch(`/api/get_player.php?id=${e}`);if(!n.ok)throw new Error("Игрок не найден");const s=await n.json();try{const e=await fetch(`/api/get_fantasy_points.php?player_id=${s.id}`);if(e.ok){const t=await e.json();t&&t.success&&"number"==typeof t.points&&(s.fantasy_points=t.points,console.log(`Fantasy XP добавлено: +${t.points}`))}}catch(e){console.warn("Ошибка загрузки fantasy points:",e)}const i=document.querySelector(".bg-fixed");if(i&&s.full_image_path&&(i.style.backgroundImage=`url('${s.full_image_path}')`),s.full_image_path){const e=document.querySelector(".player_page");e&&(e.style.backgroundImage=`url('${s.full_image_path}')`,e.style.backgroundSize="cover",e.style.backgroundRepeat="no-repeat",e.style.backgroundPosition="center",e.style.backgroundAttachment="fixed",e.style.backgroundColor="transparent",e.style.minHeight="100vh")}let r=0,l=0;if(!s||!s.id)throw new Error("Данные игрока неполные");document.title=`${s.name} ${s.patronymic||""} | FC Inter Moscow`.trim();const o=document.querySelector(".player-card img");try{const e=await fetch(`/api/get_player_frame.php?player_id=${s.id}`),t=await e.json(),a=t&&t.frame_key?t.frame_key:"";switch(o.classList.remove("frame-gold","frame-gold-glow","frame-green","frame-green-glow","frame-blue","frame-blue-glow","frame-purple","frame-purple-glow"),a){case"gold":o.classList.add("frame-gold");break;case"gold_glow":o.classList.add("frame-gold-glow");break;case"green":o.classList.add("frame-green");break;case"green_glow":o.classList.add("frame-green-glow");break;case"blue":o.classList.add("frame-blue");break;case"blue_glow":o.classList.add("frame-blue-glow");break;case"purple":o.classList.add("frame-purple");break;case"purple_glow":o.classList.add("frame-purple-glow")}}catch(e){console.warn("frame fetch fail",e)}o.src=`/img/player/player_${s.id}.png`,o.alt=`${s.name} ${s.patronymic||""}`.trim(),o.onerror=()=>{o.src="/img/player/player_0.png"};const c=document.querySelector(".player-info"),m=new Date(s.join_date),d=new Date;r=d.getFullYear()-m.getFullYear(),l=d.getMonth()-m.getMonth(),l<0&&(r--,l+=12);const g=[];r>0&&g.push(`${r} ${a(r,["год","года","лет"])}`),l>0&&g.push(`${l} ${a(l,["месяц","месяца","месяцев"])}`),document.querySelector(".player-name").textContent=`${s.name} ${s.patronymic||""}`.trim(),c.innerHTML=`\n            <p><strong>Номер:</strong> ${s.number}</p>\n            <p><strong>Позиция:</strong> ${s.position}</p>\n            <p><strong>Рост:</strong> ${s.height_cm||"-"}</p>\n            <p><strong>Вес:</strong> ${s.weight_kg||"-"}</p>\n            <p><strong>Возраст:</strong> ${function(e){const t=new Date(e),a=new Date;let n=a.getFullYear()-t.getFullYear();const s=a.getMonth()-t.getMonth();return(s<0||0===s&&a.getDate()<t.getDate())&&n--,n}(s.birth_date)}</p>\n            <p><strong>Присоединился:</strong> ${t(s.join_date,"short")}</p>\n            <p><strong>Дата Рождения:</strong> ${t(s.birth_date,"numeric")}</p>\n            <p><strong>Время в команде:</strong> ${g.join(" ")||"менее месяца"}</p>\n        `;const p=await fetch(`/api/player_statistics_all.php?id=${s.id}`);if(!p.ok)throw new Error("Ошибка загрузки статистики");const u=await p.json(),y=u.season||{},h=u.all||{},v=["matches","goals","assists","zeromatch","lostgoals","zanetti_priz"].every((e=>!h[e]||0===Number(h[e]))),f=e=>({matches:Number(e.matches)||0,goals:Number(e.goals)||0,assists:Number(e.assists)||0,zeromatch:Number(e.zeromatch)||0,lostgoals:Number(e.lostgoals)||0,zanetti_priz:Number(e.zanetti_priz)||0}),b=new Date(s.join_date);let $=0;const w=b.getFullYear(),_=b.getMonth(),x=d.getFullYear(),z=d.getMonth();d.getDate(),w<x?$=z:w===x&&($=_<z?z-_:_===z&&d.getDate()>=28?1:0),$=Math.max(0,$);const k=100*$+50*(y.matches||0)+100*(y.goals||0)+100*(y.assists||0)+250*(y.zeromatch||0),L=document.getElementById("year-exp");L&&(L.textContent=k);const S=f(y),M=f(h),q=v?S:{matches:S.matches+M.matches,goals:S.goals+M.goals,assists:S.assists+M.assists,zeromatch:S.zeromatch+M.zeromatch,lostgoals:S.lostgoals+M.lostgoals,zanetti_priz:S.zanetti_priz+M.zanetti_priz};document.querySelector(".season-stats").innerHTML=`\n            <div><div class="number">${y.matches||0}</div>Матчей</div>\n            <div><div class="number">${y.goals||0}</div>Голов</div>\n            <div><div class="number">${y.assists||0}</div>Ассистов</div>\n            <div><div class="number">${(y.goals||0)+(y.assists||0)}</div>Гол+пас</div>\n            <div><div class="number">${y.lostgoals||0}</div>Голов пропущено</div>\n            <div><div class="number">${y.zeromatch||0}</div>Матчей на 0</div>\n        `,document.querySelector(".all-stats").innerHTML=`\n            <div><div class="number number2 matches">${q.matches}</div>Матчей</div>\n            <div><div class="number number2 goals">${q.goals}</div>Голов</div>\n            <div><div class="number number2 assists">${q.assists}</div>Ассистов</div>\n            <div><div class="number">${q.goals+q.assists}</div>Гол+пас</div>\n            <div><div class="number number2 lostgoals">${q.lostgoals}</div>Голов пропущено</div>\n            <div><div class="number number2 zeromatch">${q.zeromatch}</div>Матчей на 0</div>\n        `;const D=document.querySelector(".card.success"),E=document.querySelector(".success-list"),j=document.getElementById("success-count"),[C,F]=await Promise.all([fetch("/api/get_success_list.php"),fetch(`/api/get_player_success.php?player_id=${s.id}`)]);let H=0;const T=await C.json(),I=await F.json(),N=T.filter((e=>I.includes(e.id))),Y=N.reduce(((e,t)=>e+(t.points||0)),0);H=Y;const B=s.fantasy_points||0,P=function(e=0){const{matches:t,goals:a,assists:n,zeromatch:s,zanetti_priz:i}=q;return 100*(12*r+l)+50*t+100*a+100*n+250*s+25*i+e}(H)+B;if(function(e){const t=[{limit:500,name:"Новичок"},{limit:1e3,name:"Перспективный"},{limit:2500,name:"Футболист"},{limit:5e3,name:"Опытный"},{limit:7500,name:"Старожил"},{limit:1e4,name:"Мастер"},{limit:12500,name:"Герой"},{limit:15e3,name:"Магистр"},{limit:2e4,name:"Посвященный"},{limit:25e3,name:"Ветеран"},{limit:3e4,name:"Виртуоз"},{limit:35e3,name:"Элита"},{limit:45e3,name:"Чемпион"},{limit:6e4,name:"Хранитель"},{limit:75e3,name:"Вершитель"},{limit:1e5,name:"Избранный"},{limit:125e3,name:"Мудрец"},{limit:15e4,name:"Наставник"},{limit:175e3,name:"Архонт"},{limit:2e5,name:"Маэстро"},{limit:225e3,name:"Хранитель огня"},{limit:25e4,name:"Лидер эпохи"},{limit:275e3,name:"Идеал"},{limit:3e5,name:"Миф"},{limit:35e4,name:"Символ клуба"},{limit:4e5,name:"Бессмертный"},{limit:45e4,name:"Наследие"},{limit:5e5,name:"Полубог"},{limit:1/0,name:"Легенда"}],a=t.find((t=>e<=t.limit))||t.at(-1),n=t[t.indexOf(a)-1]?.limit||0,i=a.limit===1/0?100:Math.min(100,(e-n)/(a.limit-n)*100);document.getElementById("experience-bar-fill").style.width=`${i}%`,document.getElementById("experience-bar-text").textContent=`${e} / ${a.limit===1/0?"∞":a.limit}`,document.getElementById("title").textContent=a.name,document.querySelector(".player-card img");const r=document.querySelector(".player-star"),l=document.querySelector(".player-name");a.limit>=2500?r.style.display="block":r.style.display="none",l.textContent=`${s.name} ${s.patronymic||""}`.trim()}(P),B>0){const e=document.querySelector("#experience-bar-text");e&&!document.querySelector(".xp-fantasy")&&e.insertAdjacentHTML("afterend",`<div class="xp-fantasy" style="font-size:14px;color:#FDC500;margin-top:4px;">\n        +${B} XP (Fantasy)\n      </div>`)}D.style.display=N.length>0?"block":"none",j.textContent=`${N.length} / ${T.length} • ${Y} очков`,E.innerHTML="",N.forEach((e=>{const t=`/img/success/success-${e.id}.png`,a=document.createElement("div");a.className="success-item",a.style.marginBottom="14px",a.style.paddingTop="10px",a.innerHTML=`\n                <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">\n                    <img src="${t}" onerror="this.src='/img/success/success-0.png'" width="50" height="50" style="border-radius: 6px; flex-shrink: 0;">\n                    <div style="flex: 1;">\n                        <div style="font-weight: bold;">${e.title}</div>\n                        <div style="color: #c5c2c2; font-size: 14px;">${e.description}</div>\n                    </div>\n                    <div style="color: #2D62B5; font-weight: bold; font-size: 14px;">${e.points} очков</div>\n                </div>\n            `,E.appendChild(a)}));const A=document.querySelector(".achievements-card"),R=A?.querySelector(".achievements-list");try{const e=await fetch(`/api/achievements.php?player_id=${s.id}`),t=await e.text(),a=JSON.parse(t);H+=1e3*(a?.length||0),A.style.display="block",R.innerHTML="",Array.isArray(a)&&a.length>0?a.forEach((e=>{const t=document.createElement("div");t.classList.add("career-item"),t.innerHTML=`\n                        ${e.award_title}<span>${e.award_year}</span>\n                        <small>${e.team_name}</small>\n                    `,R.appendChild(t)})):R.innerHTML='<div class="empty-achievements">Нет достижений</div>'}catch(e){console.error("Ошибка при загрузке достижений:",e),A&&R&&(A.style.display="block",R.innerHTML='<div class="error-msg">Не удалось загрузить достижения</div>')}}catch(e){console.error("Ошибка при загрузке данных игрока:",e)}}));