document.addEventListener("DOMContentLoaded",(async()=>{const e=new URLSearchParams(window.location.search).get("id");if(!e)return console.error("ID игрока не указан в URL");function t(e,t="full"){const i=new Date(e);return"short"===t?i.getFullYear().toString():"numeric"===t?`${String(i.getDate()).padStart(2,"0")}.${String(i.getMonth()+1).padStart(2,"0")}.${i.getFullYear()}`:i.toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"})}function i(e,t){const i=e%10,n=e%100;return n>=11&&n<=14?t[2]:1===i?t[0]:i>=2&&i<=4?t[1]:t[2]}try{const n=await fetch(`/api/get_player.php?id=${e}`);if(!n.ok)throw new Error("Игрок не найден");const s=await n.json();let a=0,o=0;const r=document.querySelector(".player-card img");r.src=`/img/player/player_${s.id}.png`,r.alt=`${s.name} ${s.patronymic||""}`.trim(),r.onerror=()=>{r.src="/img/player/player_0.png"};const l=document.querySelector(".player-info"),m=new Date(s.join_date),c=new Date;a=c.getFullYear()-m.getFullYear(),o=c.getMonth()-m.getMonth(),o<0&&(a--,o+=12);const d=[];a>0&&d.push(`${a} ${i(a,["год","года","лет"])}`),o>0&&d.push(`${o} ${i(o,["месяц","месяца","месяцев"])}`),document.querySelector(".player-name").textContent=`${s.name} ${s.patronymic||""}`.trim(),l.innerHTML=`\n            <p><strong>Номер:</strong> ${s.number}</p>\n            <p><strong>Позиция:</strong> ${s.position}</p>\n            <p><strong>Рост:</strong> ${s.height_cm||"-"}</p>\n            <p><strong>Вес:</strong> ${s.weight_kg||"-"}</p>\n            <p><strong>Возраст:</strong> ${function(e){const t=new Date(e),i=new Date;let n=i.getFullYear()-t.getFullYear();const s=i.getMonth()-t.getMonth();return(s<0||0===s&&i.getDate()<t.getDate())&&n--,n}(s.birth_date)}</p>\n            <p><strong>Присоединился:</strong> ${t(s.join_date,"short")}</p>\n            <p><strong>Дата Рождения:</strong> ${t(s.birth_date,"numeric")}</p>\n            <p><strong>Время в команде:</strong> ${d.join(" ")||"менее месяца"}</p>\n        `;const g=await fetch(`/api/player_statistics_all.php?id=${s.id}`);if(!g.ok)throw new Error("Ошибка загрузки статистики");const u=await g.json(),p=u.season||{},h=u.all||{},v=["matches","goals","assists","zeromatch","lostgoals","zanetti_priz"].every((e=>!h[e]||0===Number(h[e]))),$=e=>({matches:Number(e.matches)||0,goals:Number(e.goals)||0,assists:Number(e.assists)||0,zeromatch:Number(e.zeromatch)||0,lostgoals:Number(e.lostgoals)||0}),y=$(p),b=$(h),f=v?y:{matches:y.matches+b.matches,goals:y.goals+b.goals,assists:y.assists+b.assists,zeromatch:y.zeromatch+b.zeromatch,lostgoals:y.lostgoals+b.lostgoals};document.querySelector(".season-stats").innerHTML=`\n            <div><div class="number">${p.matches||0}</div>Матчей</div>\n            <div><div class="number">${p.goals||0}</div>Голов</div>\n            <div><div class="number">${p.assists||0}</div>Ассистов</div>\n            <div><div class="number">${(p.goals||0)+(p.assists||0)}</div>Гол+пас</div>\n            <div><div class="number">${p.lostgoals||0}</div>Голов пропущено</div>\n            <div><div class="number">${p.zeromatch||0}</div>Матчей на 0</div>\n        `,document.querySelector(".all-stats").innerHTML=`\n            <div><div class="number number2 matches">${f.matches}</div>Матчей</div>\n            <div><div class="number number2 goals">${f.goals}</div>Голов</div>\n            <div><div class="number number2 assists">${f.assists}</div>Ассистов</div>\n            <div><div class="number">${f.goals+f.assists}</div>Гол+пас</div>\n            <div><div class="number number2 lostgoals">${f.lostgoals}</div>Голов пропущено</div>\n            <div><div class="number number2 zeromatch">${f.zeromatch}</div>Матчей на 0</div>\n        `;const w=document.querySelector(".card.success"),x=document.querySelector(".success-list"),_=document.getElementById("success-count"),[z,S]=await Promise.all([fetch("/api/get_success_list.php"),fetch(`/api/get_player_success.php?player_id=${s.id}`)]),D=await z.json(),M=await S.json(),L=D.filter((e=>M.includes(e.id))),E=L.reduce(((e,t)=>e+(t.points||0)),0);w.style.display=L.length>0?"block":"none",_.textContent=`${L.length} / ${D.length} • ${E} очков`,x.innerHTML="",L.forEach((e=>{const t=`/img/success/success-${e.id}.png`,i=document.createElement("div");i.className="success-item",i.style.marginBottom="14px",i.style.paddingTop="10px",i.innerHTML=`\n                <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">\n                    <img src="${t}" onerror="this.src='/img/success/success-0.png'" width="50" height="50" style="border-radius: 6px; flex-shrink: 0;">\n                    <div style="flex: 1;">\n                        <div style="font-weight: bold;">${e.title}</div>\n                        <div style="color: #c5c2c2; font-size: 14px;">${e.description}</div>\n                    </div>\n                    <div style="color: #2D62B5; font-weight: bold; font-size: 14px;">${e.points} очков</div>\n                </div>\n            `,x.appendChild(i)})),function(e){const t=[{limit:500,name:"Новичок"},{limit:1e3,name:"Перспективный"},{limit:2500,name:"Футболист"},{limit:5e3,name:"Опытный"},{limit:7500,name:"Старожил"},{limit:1e4,name:"Мастер"},{limit:12500,name:"Герой"},{limit:15e3,name:"Магистр"},{limit:2e4,name:"Посвященный"},{limit:25e3,name:"Ветеран"},{limit:3e4,name:"Виртуоз"},{limit:35e3,name:"Элита"},{limit:45e3,name:"Чемпион"},{limit:6e4,name:"Хранитель"},{limit:75e3,name:"Вершитель"},{limit:9e4,name:"Избранный"},{limit:11e4,name:"Мудрец"},{limit:13e4,name:"Наставник"},{limit:15e4,name:"Вдохновитель"},{limit:175e3,name:"Архонт"},{limit:2e5,name:"Маэстро"},{limit:225e3,name:"Хранитель огня"},{limit:25e4,name:"Лидер эпохи"},{limit:275e3,name:"Идеал"},{limit:3e5,name:"Миф"},{limit:35e4,name:"Символ клуба"},{limit:4e5,name:"Бессмертный"},{limit:45e4,name:"Наследие"},{limit:5e5,name:"Полубог"},{limit:1/0,name:"Легенда"}],i=t.find((t=>e<=t.limit))||t.at(-1),n=t[t.indexOf(i)-1]?.limit||0,s=i.limit===1/0?100:Math.min(100,(e-n)/(i.limit-n)*100);document.getElementById("experience-bar-fill").style.width=`${s}%`,document.getElementById("experience-bar-text").textContent=`${e} / ${i.limit===1/0?"∞":i.limit}`,document.getElementById("title").textContent=i.name}(function(e=0){const{matches:t,goals:i,assists:n,zeromatch:s}=f;return 100*(12*a+o)+50*t+125*i+100*n+250*s+e}(E))}catch(e){console.error("Ошибка при загрузке данных игрока:",e)}}));