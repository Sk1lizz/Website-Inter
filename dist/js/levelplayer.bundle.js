document.addEventListener("DOMContentLoaded",(async()=>{const e=new URLSearchParams(window.location.search).get("id");if(!e)return console.error("ID игрока не указан в URL");function t(e,t="full"){const n=new Date(e);return"short"===t?n.getFullYear().toString():"numeric"===t?`${String(n.getDate()).padStart(2,"0")}.${String(n.getMonth()+1).padStart(2,"0")}.${n.getFullYear()}`:n.toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"})}function n(e,t){const n=e%10,s=e%100;return s>=11&&s<=14?t[2]:1===n?t[0]:n>=2&&n<=4?t[1]:t[2]}try{const s=await fetch(`/api/get_player.php?id=${e}`);if(!s.ok)throw new Error("Игрок не найден");const i=await s.json();let a=0,r=0;const o=document.querySelector(".player-card img");o.src=`/img/player/player_${i.id}.png`,o.alt=`${i.name} ${i.patronymic||""}`.trim(),o.onerror=()=>{o.src="/img/player/player_0.png"};const l=document.querySelector(".player-info"),m=new Date(i.join_date),c=new Date;a=c.getFullYear()-m.getFullYear(),r=c.getMonth()-m.getMonth(),r<0&&(a--,r+=12);const d=[];a>0&&d.push(`${a} ${n(a,["год","года","лет"])}`),r>0&&d.push(`${r} ${n(r,["месяц","месяца","месяцев"])}`),document.querySelector(".player-name").textContent=`${i.name} ${i.patronymic||""}`.trim(),l.innerHTML=`\n            <p><strong>Номер:</strong> ${i.number}</p>\n            <p><strong>Позиция:</strong> ${i.position}</p>\n            <p><strong>Рост:</strong> ${i.height_cm||"-"}</p>\n            <p><strong>Вес:</strong> ${i.weight_kg||"-"}</p>\n            <p><strong>Возраст:</strong> ${function(e){const t=new Date(e),n=new Date;let s=n.getFullYear()-t.getFullYear();const i=n.getMonth()-t.getMonth();return(i<0||0===i&&n.getDate()<t.getDate())&&s--,s}(i.birth_date)}</p>\n            <p><strong>Присоединился:</strong> ${t(i.join_date,"short")}</p>\n            <p><strong>Дата Рождения:</strong> ${t(i.birth_date,"numeric")}</p>\n            <p><strong>Время в команде:</strong> ${d.join(" ")||"менее месяца"}</p>\n        `;const g=await fetch(`/api/player_statistics_all.php?id=${i.id}`);if(!g.ok)throw new Error("Ошибка загрузки статистики");const u=await g.json(),v=u.season||{},h=u.all||{},p=["matches","goals","assists","zeromatch","lostgoals","zanetti_priz"].every((e=>!h[e]||0===Number(h[e]))),$=e=>({matches:Number(e.matches)||0,goals:Number(e.goals)||0,assists:Number(e.assists)||0,zeromatch:Number(e.zeromatch)||0,lostgoals:Number(e.lostgoals)||0}),y=$(v),b=$(h),w=p?y:{matches:y.matches+b.matches,goals:y.goals+b.goals,assists:y.assists+b.assists,zeromatch:y.zeromatch+b.zeromatch,lostgoals:y.lostgoals+b.lostgoals};document.querySelector(".season-stats").innerHTML=`\n            <div><div class="number">${v.matches||0}</div>Матчей</div>\n            <div><div class="number">${v.goals||0}</div>Голов</div>\n            <div><div class="number">${v.assists||0}</div>Ассистов</div>\n            <div><div class="number">${(v.goals||0)+(v.assists||0)}</div>Гол+пас</div>\n            <div><div class="number">${v.lostgoals||0}</div>Голов пропущено</div>\n            <div><div class="number">${v.zeromatch||0}</div>Матчей на 0</div>\n        `,document.querySelector(".all-stats").innerHTML=`\n            <div><div class="number number2 matches">${w.matches}</div>Матчей</div>\n            <div><div class="number number2 goals">${w.goals}</div>Голов</div>\n            <div><div class="number number2 assists">${w.assists}</div>Ассистов</div>\n            <div><div class="number">${w.goals+w.assists}</div>Гол+пас</div>\n            <div><div class="number number2 lostgoals">${w.lostgoals}</div>Голов пропущено</div>\n            <div><div class="number number2 zeromatch">${w.zeromatch}</div>Матчей на 0</div>\n        `,function(e){const t=[{limit:500,name:"Новичок"},{limit:1e3,name:"Перспективный"},{limit:2500,name:"Футболист"},{limit:5e3,name:"Опытный"},{limit:7500,name:"Старожил"},{limit:1e4,name:"Мастер"},{limit:12500,name:"Герой"},{limit:15e3,name:"Магистр"},{limit:2e4,name:"Посвященный"},{limit:25e3,name:"Ветеран"},{limit:3e4,name:"Виртуоз"},{limit:35e3,name:"Элита"},{limit:45e3,name:"Чемпион"},{limit:6e4,name:"Хранитель"},{limit:75e3,name:"Вершитель"},{limit:9e4,name:"Избранный"},{limit:1/0,name:"Легенда"}],n=t.find((t=>e<=t.limit))||t.at(-1),s=t[t.indexOf(n)-1]?.limit||0,i=n.limit===1/0?100:Math.min(100,(e-s)/(n.limit-s)*100);document.getElementById("experience-bar-fill").style.width=`${i}%`,document.getElementById("experience-bar-text").textContent=`${e} / ${n.limit===1/0?"∞":n.limit}`,document.getElementById("title").textContent=n.name}(function(){const e=w.matches,t=w.goals,n=w.assists,s=w.zeromatch;return 100*(12*a+r)+50*e+125*t+100*n+250*s}());const f=document.querySelector(".achievements-card"),_=f?.querySelector(".achievements-list");try{const e=await fetch(`/api/achievements.php?player_id=${i.id}`);if(!e.ok)throw new Error("Ошибка при получении достижений");const t=await e.json();f&&_&&(f.style.display="block",_.innerHTML="",t.length>0?t.forEach((e=>{const t=document.createElement("div");t.classList.add("career-item"),t.innerHTML=`\n                            ${e.award_title}<span>${e.award_year}</span>\n                            <small>${e.team_name}</small>\n                        `,_.appendChild(t)})):_.innerHTML='<div class="empty-achievements">Нет достижений</div>')}catch(e){console.error("Ошибка при загрузке достижений:",e),f&&_&&(f.style.display="block",_.innerHTML='<div class="error-msg">Не удалось загрузить достижения</div>')}}catch(e){console.error("Ошибка при загрузке данных игрока:",e)}}));