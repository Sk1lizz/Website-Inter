document.addEventListener("DOMContentLoaded",(async()=>{const e=new URLSearchParams(window.location.search).get("id");if(!e)return console.error("ID игрока не указан в URL");function t(e,t="full"){const n=new Date(e);return"short"===t?n.getFullYear().toString():"numeric"===t?`${String(n.getDate()).padStart(2,"0")}.${String(n.getMonth()+1).padStart(2,"0")}.${n.getFullYear()}`:n.toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"})}function n(e,t){const n=e%10,i=e%100;return i>=11&&i<=14?t[2]:1===n?t[0]:n>=2&&n<=4?t[1]:t[2]}try{const a=await fetch(`/api/get_player.php?id=${e}`);if(!a.ok)throw new Error("Игрок не найден");const r=await a.json(),o=document.querySelector(".bg-fixed");if(o&&r.background_key&&""!==r.background_key.trim()&&(o.style.backgroundImage=`url('/img/background_player/${r.background_key}.png')`),r.background_key&&""!==r.background_key.trim()){const A=document.querySelector(".player_page");A&&(A.style.backgroundImage=`url('/img/background_player/${r.background_key}.png')`,A.style.backgroundSize="cover",A.style.backgroundRepeat="no-repeat",A.style.backgroundPosition="center",A.style.backgroundAttachment="fixed",A.style.backgroundColor="transparent",A.style.minHeight="100vh")}let l=0,c=0;if(!r||!r.id)throw new Error("Данные игрока неполные");document.title=`${r.name} ${r.patronymic||""} | FC Inter Moscow`.trim();const m=document.querySelector(".player-card img");m.src=`/img/player/player_${r.id}.png`,m.alt=`${r.name} ${r.patronymic||""}`.trim(),m.onerror=()=>{m.src="/img/player/player_0.png"};const d=document.querySelector(".player-info"),g=new Date(r.join_date),u=new Date;l=u.getFullYear()-g.getFullYear(),c=u.getMonth()-g.getMonth(),c<0&&(l--,c+=12);const p=[];l>0&&p.push(`${l} ${n(l,["год","года","лет"])}`),c>0&&p.push(`${c} ${n(c,["месяц","месяца","месяцев"])}`),document.querySelector(".player-name").textContent=`${r.name} ${r.patronymic||""}`.trim(),d.innerHTML=`\n            <p><strong>Номер:</strong> ${r.number}</p>\n            <p><strong>Позиция:</strong> ${r.position}</p>\n            <p><strong>Рост:</strong> ${r.height_cm||"-"}</p>\n            <p><strong>Вес:</strong> ${r.weight_kg||"-"}</p>\n            <p><strong>Возраст:</strong> ${function(e){const t=new Date(e),n=new Date;let i=n.getFullYear()-t.getFullYear();const s=n.getMonth()-t.getMonth();return(s<0||0===s&&n.getDate()<t.getDate())&&i--,i}(r.birth_date)}</p>\n            <p><strong>Присоединился:</strong> ${t(r.join_date,"short")}</p>\n            <p><strong>Дата Рождения:</strong> ${t(r.birth_date,"numeric")}</p>\n            <p><strong>Время в команде:</strong> ${p.join(" ")||"менее месяца"}</p>\n        `;const y=await fetch(`/api/player_statistics_all.php?id=${r.id}`);if(!y.ok)throw new Error("Ошибка загрузки статистики");const h=await y.json(),v=h.season||{},$=h.all||{},b=["matches","goals","assists","zeromatch","lostgoals","zanetti_priz"].every((e=>!$[e]||0===Number($[e]))),f=e=>({matches:Number(e.matches)||0,goals:Number(e.goals)||0,assists:Number(e.assists)||0,zeromatch:Number(e.zeromatch)||0,lostgoals:Number(e.lostgoals)||0}),w=new Date(r.join_date);let k=0;const _=w.getFullYear(),x=w.getMonth(),z=u.getFullYear(),S=u.getMonth();u.getDate(),_<z?k=S:_===z&&(k=x<S?S-x:x===S&&u.getDate()>=28?1:0),k=Math.max(0,k);const M=100*k+50*(v.matches||0)+100*(v.goals||0)+100*(v.assists||0)+250*(v.zeromatch||0),E=document.getElementById("year-exp");E&&(E.textContent=M);const L=f(v),D=f($),q=b?L:{matches:L.matches+D.matches,goals:L.goals+D.goals,assists:L.assists+D.assists,zeromatch:L.zeromatch+D.zeromatch,lostgoals:L.lostgoals+D.lostgoals};function i(e=0){const{matches:t,goals:n,assists:i,zeromatch:s}=q;return 100*(12*l+c)+50*t+100*n+100*i+250*s+e}function s(e){const t=[{limit:500,name:"Новичок"},{limit:1e3,name:"Перспективный"},{limit:2500,name:"Футболист"},{limit:5e3,name:"Опытный"},{limit:7500,name:"Старожил"},{limit:1e4,name:"Мастер"},{limit:12500,name:"Герой"},{limit:15e3,name:"Магистр"},{limit:2e4,name:"Посвященный"},{limit:25e3,name:"Ветеран"},{limit:3e4,name:"Виртуоз"},{limit:35e3,name:"Элита"},{limit:45e3,name:"Чемпион"},{limit:6e4,name:"Хранитель"},{limit:75e3,name:"Вершитель"},{limit:1e5,name:"Избранный"},{limit:125e3,name:"Мудрец"},{limit:15e4,name:"Наставник"},{limit:175e3,name:"Архонт"},{limit:2e5,name:"Маэстро"},{limit:225e3,name:"Хранитель огня"},{limit:25e4,name:"Лидер эпохи"},{limit:275e3,name:"Идеал"},{limit:3e5,name:"Миф"},{limit:35e4,name:"Символ клуба"},{limit:4e5,name:"Бессмертный"},{limit:45e4,name:"Наследие"},{limit:5e5,name:"Полубог"},{limit:1/0,name:"Легенда"}],n=t.find((t=>e<=t.limit))||t.at(-1),i=t[t.indexOf(n)-1]?.limit||0,s=n.limit===1/0?100:Math.min(100,(e-i)/(n.limit-i)*100);document.getElementById("experience-bar-fill").style.width=`${s}%`,document.getElementById("experience-bar-text").textContent=`${e} / ${n.limit===1/0?"∞":n.limit}`,document.getElementById("title").textContent=n.name;const a=document.querySelector(".player-card img");n.limit>=5e3?a.classList.add("gold-frame"):a.classList.remove("gold-frame");const o=document.querySelector(".player-star"),l=document.querySelector(".player-name");n.limit>=2500?o.style.display="block":o.style.display="none",l.textContent=`${r.name} ${r.patronymic||""}`.trim();const c=["Страница на сайте","Поздравление в соцсетях с Днем Рождения","Эмодзи звезда в профиле","Золотая рамка фотографии на сайте","Книга от руководителя команды","Интервью + пост в соцсетях","Фон профиля на выбор","Подписка на Okko на 1 месяц","Разбор игры с ТТД","Футболка гостевая/тренировочная","Telegram Premium подписка","Матч в роли капитана","Футболка гостевая/тренировочная","1 месяц тренировок или 3 мес без взносов (8x8)","Футболка-поло с логотипом","Зал Славы + футболка с золотым номером","Ветровка Kappa","В разработке"],m=(document.getElementById("current-prize"),document.getElementById("current-prize-img")),d=document.getElementById("current-prize-desc"),g=document.getElementById("next-prize-img"),u=document.getElementById("next-prize-desc"),p=t.indexOf(n);t[p+1],m&&d&&(m.src=`/img/prize/prize-${p+1}.png`,d.textContent=c[p]||"Без приза"),g&&u&&(g.src=`/img/prize/prize-${p+2}.png`,u.textContent=c[p+1]||"–")}document.querySelector(".season-stats").innerHTML=`\n            <div><div class="number">${v.matches||0}</div>Матчей</div>\n            <div><div class="number">${v.goals||0}</div>Голов</div>\n            <div><div class="number">${v.assists||0}</div>Ассистов</div>\n            <div><div class="number">${(v.goals||0)+(v.assists||0)}</div>Гол+пас</div>\n            <div><div class="number">${v.lostgoals||0}</div>Голов пропущено</div>\n            <div><div class="number">${v.zeromatch||0}</div>Матчей на 0</div>\n        `,document.querySelector(".all-stats").innerHTML=`\n            <div><div class="number number2 matches">${q.matches}</div>Матчей</div>\n            <div><div class="number number2 goals">${q.goals}</div>Голов</div>\n            <div><div class="number number2 assists">${q.assists}</div>Ассистов</div>\n            <div><div class="number">${q.goals+q.assists}</div>Гол+пас</div>\n            <div><div class="number number2 lostgoals">${q.lostgoals}</div>Голов пропущено</div>\n            <div><div class="number number2 zeromatch">${q.zeromatch}</div>Матчей на 0</div>\n        `;const I=document.querySelector(".card.success"),C=document.querySelector(".success-list"),B=document.getElementById("success-count"),[T,H]=await Promise.all([fetch("/api/get_success_list.php"),fetch(`/api/get_player_success.php?player_id=${r.id}`)]);let j=0;const F=await T.json(),N=await H.json(),Y=F.filter((e=>N.includes(e.id))),O=Y.reduce(((e,t)=>e+(t.points||0)),0);j=O,s(i(j)),I.style.display=Y.length>0?"block":"none",B.textContent=`${Y.length} / ${F.length} • ${O} очков`,C.innerHTML="",Y.forEach((e=>{const t=`/img/success/success-${e.id}.png`,n=document.createElement("div");n.className="success-item",n.style.marginBottom="14px",n.style.paddingTop="10px",n.innerHTML=`\n                <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">\n                    <img src="${t}" onerror="this.src='/img/success/success-0.png'" width="50" height="50" style="border-radius: 6px; flex-shrink: 0;">\n                    <div style="flex: 1;">\n                        <div style="font-weight: bold;">${e.title}</div>\n                        <div style="color: #c5c2c2; font-size: 14px;">${e.description}</div>\n                    </div>\n                    <div style="color: #2D62B5; font-weight: bold; font-size: 14px;">${e.points} очков</div>\n                </div>\n            `,C.appendChild(n)})),s(i(O));const P=document.querySelector(".achievements-card"),R=P?.querySelector(".achievements-list");try{const U=await fetch(`/api/achievements.php?player_id=${r.id}`),J=await U.text(),K=JSON.parse(J);j+=1e3*(K?.length||0),s(i(j)),P.style.display="block",R.innerHTML="",Array.isArray(K)&&K.length>0?K.forEach((e=>{const t=document.createElement("div");t.classList.add("career-item"),t.innerHTML=`\n                        ${e.award_title}<span>${e.award_year}</span>\n                        <small>${e.team_name}</small>\n                    `,R.appendChild(t)})):R.innerHTML='<div class="empty-achievements">Нет достижений</div>'}catch(G){console.error("Ошибка при загрузке достижений:",G),P&&R&&(P.style.display="block",R.innerHTML='<div class="error-msg">Не удалось загрузить достижения</div>')}}catch(Q){console.error("Ошибка при загрузке данных игрока:",Q)}}));